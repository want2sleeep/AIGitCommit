# Changelog

All notable changes to the "AI Git Commit" extension will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [0.1.5] - 2024-11-15

### 🐛 Bug 修复

#### Think 标签过滤

- ✅ **移除 Think 标签**: 修复某些 LLM（如 Claude）在响应中包含 `<think>` 标签导致提交信息不纯净的问题 (需求 1.1-1.5)
  - 自动检测并移除所有 `<think>...</think>` 标签块及其内容
  - 支持多行、多个标签块和不规范格式的处理
  - 清理移除标签后产生的多余空白行
  - 快速检测优化：不包含 think 标签时跳过处理

#### 响应验证增强

- ✅ **内容验证**: 增强响应内容验证机制 (需求 2.1-2.5)
  - 验证移除 think 标签后内容不为空
  - 提供友好的错误提示，引导用户重新生成
  - 确保提交信息格式符合基本要求

#### 提示词优化

- ✅ **禁止 Think 标签**: 在系统提示词中明确要求 LLM 不使用思考标签 (需求 3.1-3.5)
  - 中文提示词添加"不要使用<think>标签或展示思考过程"
  - 英文提示词添加"Do not use <think> tags or show thinking process"
  - 明确要求不包含任何 XML 标签或特殊标记
  - 从源头减少 think 标签出现的可能性

#### 日志和调试

- ✅ **增强日志**: 改进日志记录机制 (需求 4.1-4.5)
  - 检测到 think 标签时记录警告日志
  - 调试模式下记录原始响应和处理后的结果
  - 提供详细的错误信息用于问题排查

### 🔧 技术改进

#### 新增方法

- **removeThinkTags**: 私有方法，用于移除 think 标签及其内容
  - 使用正则表达式处理多种格式的 think 标签
  - 支持不区分大小写的匹配
  - 清理多余空白行，保持格式整洁

#### 方法增强

- **parseCommitMessage**: 集成 think 标签过滤
  - 在解析开始时调用 removeThinkTags
  - 添加内容验证，确保处理后内容有效
  - 保持与现有清理逻辑的兼容性

- **buildSystemPrompt**: 优化系统提示词
  - 添加明确的反 think 标签指令
  - 中英文提示词同步更新
  - 保持提示词的清晰性和有效性

### 🧪 测试覆盖

- ✅ **单元测试**: 完整的测试覆盖 (需求 5.1-5.5)
  - 测试正常响应处理（无 think 标签）
  - 测试单个和多个 think 标签块的移除
  - 测试多行内容和不规范格式的处理
  - 测试 think 标签与其他格式混合的情况
  - 测试错误处理（移除后内容为空）

### 📚 向后兼容

- ✅ **完全兼容**: 保持与现有功能的完全兼容 (需求 5.1-5.5)
  - 不影响不包含 think 标签的正常响应
  - 保持现有的提交信息格式和质量
  - 不改变其他模块的行为
  - 性能影响可忽略不计

### ⚡ 性能优化

- **快速检测**: 在执行正则替换前先检查是否包含 think 标签
- **最小开销**: 对于不包含 think 标签的响应，处理时间 <1ms
- **无性能影响**: 不影响整体响应时间和用户体验

---

## [0.1.0] - 2024-11-15

### 🎉 配置面板增强版本

本版本引入了全新的配置面板和改进的用户体验，使 LLM 服务配置更加直观和便捷。

### ✨ 新增功能

#### 专用配置面板 (需求 2)

- ✅ **Webview 配置面板**: 提供专用的可视化配置界面，替代原有的命令行配置向导 (需求 2.1)
- ✅ **实时配置加载**: 打开面板时自动加载当前配置值 (需求 2.2, 2.6)
- ✅ **配置保存**: 一键保存所有配置项到 VSCode 设置和安全存储 (需求 2.3, 2.7)
- ✅ **配置验证**: 保存前自动验证配置完整性和有效性 (需求 2.4, 7.1-7.6)
- ✅ **友好表单**: 清晰的表单布局，包含字段说明和验证提示 (需求 2.5)
- ✅ **主题适配**: 自动适配 VSCode 主题（深色/浅色模式）

#### API 提供商选择器 (需求 3)

- ✅ **下拉选择器**: 提供 API 提供商下拉选择器，支持快速选择常用服务 (需求 3.1, 3.6)
- ✅ **预定义提供商**: 内置 OpenAI、Azure OpenAI、Ollama 和自定义选项 (需求 3.2-3.5)
- ✅ **自动填充**: 选择提供商时自动填充推荐的 Base URL 和模型名称 (需求 3.6)
- ✅ **自定义支持**: 支持自定义 OpenAI 兼容服务配置 (需求 3.7)
- ✅ **提供商管理**: 新增 ProviderManager 模块管理提供商配置

#### 源代码管理视图增强 (需求 4, 5)

- ✅ **SCM 按钮集成**: 在源代码管理视图标题栏添加生成按钮，作为首选操作入口 (需求 4.1-4.5)
- ✅ **悬停提示**: 鼠标悬停在生成按钮上时显示当前配置摘要 (需求 5.1-5.3)
- ✅ **配置信息显示**: 悬停提示中显示 API 提供商、Base URL、模型名称等信息 (需求 5.4-5.5)
- ✅ **API 密钥遮蔽**: 在悬停提示中安全显示 API 密钥（部分遮蔽） (需求 5.3)
- ✅ **未配置提示**: 配置不完整时显示友好的提示信息 (需求 5.6)

#### 快速编辑入口 (需求 6)

- ✅ **编辑链接**: 悬停提示中包含"编辑配置"快捷链接 (需求 6.1)
- ✅ **一键跳转**: 点击编辑链接直接打开配置面板 (需求 6.2)
- ✅ **配置同步**: 编辑后配置立即生效，悬停提示自动更新 (需求 6.3-6.5)

#### 配置持久化增强 (需求 8)

- ✅ **提供商存储**: 将 API 提供商选择保存到 VSCode 配置 (需求 8.1)
- ✅ **安全存储**: API 密钥继续使用 SecretStorage 安全存储 (需求 8.2)
- ✅ **配置迁移**: 自动检测并迁移旧版本配置到新格式 (需求 8.5)
- ✅ **向后兼容**: 保持与旧版本配置的完全兼容 (需求 8.5)
- ✅ **多级配置**: 支持用户级和工作区级配置 (需求 8.6)

### 🔧 技术改进

#### 新增模块

- **ProviderManager**: 管理 API 提供商配置和默认值
- **ConfigurationPanelManager**: 管理 Webview 配置面板生命周期
- **ConfigurationManager 扩展**: 新增提供商相关方法和配置摘要功能

#### 架构优化

- **模块化设计**: 清晰的职责划分，提高代码可维护性
- **单例模式**: 配置面板使用单例模式，避免重复创建
- **消息通信**: Webview 与 Extension 之间使用 postMessage 双向通信
- **资源管理**: 面板关闭时自动清理资源，防止内存泄漏

#### 安全增强

- **CSP 配置**: Webview 启用 Content Security Policy
- **输入验证**: 验证所有来自 Webview 的消息和数据
- **密钥遮蔽**: 在 UI 中安全显示 API 密钥（仅显示前后 4 位）
- **日志安全**: 不在日志中记录完整的敏感信息

### 🎨 用户体验改进

#### 配置流程优化

- **一站式配置**: 所有配置项集中在一个面板中，无需多次跳转
- **智能默认值**: 根据选择的提供商自动填充推荐配置
- **实时验证**: 输入时实时验证，保存前完整验证
- **清晰反馈**: 保存成功/失败时显示明确的提示信息

#### 可发现性提升

- **显著位置**: 生成按钮放置在 SCM 视图的显著位置
- **悬停提示**: 通过悬停提示让用户了解当前配置状态
- **快速访问**: 从悬停提示一键跳转到配置编辑
- **图标优化**: 使用 ✨ (sparkle) 图标表示 AI 功能

#### 配置可见性

- **配置摘要**: 随时查看当前使用的配置信息
- **状态反馈**: 配置变更后立即更新显示
- **未配置提示**: 清晰提示用户完成必要的配置
- **配置验证**: 保存前验证配置完整性，避免错误配置

### 📚 文档更新

- ✅ **README.md**: 更新配置说明，添加配置面板使用指南
- ✅ **配置步骤**: 更新为基于配置面板的新流程
- ✅ **FAQ 扩充**: 添加配置面板相关的常见问题
- ✅ **快速入口说明**: 说明如何通过悬停提示快速访问配置

### 🔄 配置迁移

#### 自动迁移

- **旧配置检测**: 自动检测旧版本的配置格式
- **提供商推断**: 根据 API 端点自动推断提供商类型
- **无缝升级**: 用户无需手动操作，配置自动迁移
- **迁移通知**: 迁移完成后显示友好的通知信息

#### 向后兼容

- **配置格式**: 保持与旧版本配置格式的兼容
- **命令兼容**: 保留所有现有命令，不影响现有用户
- **API 兼容**: ConfigurationManager 保持现有接口不变
- **渐进增强**: 新功能作为增强，不破坏现有功能

### 🐛 Bug 修复

- 修复配置向导在某些情况下无法正确保存配置的问题
- 修复 API 密钥在日志中可能泄露的安全问题
- 改进错误提示的准确性和可读性

### ⚡ 性能优化

- **配置缓存**: 缓存配置摘要，减少重复读取
- **延迟加载**: Webview 内容延迟加载，提高响应速度
- **资源优化**: 优化 Webview 资源加载，减少内存占用
- **防抖处理**: 配置变更监听使用防抖，避免频繁更新

### 🎯 Breaking Changes

无破坏性变更。本版本完全向后兼容 v0.0.1。

### 📦 依赖更新

无新增依赖。

---

## [0.0.1] - 2024-11-14

### 🎉 Initial Release

首个版本发布，实现了基于 AI 的 Git 提交信息自动生成功能。

### ✨ Features

#### 核心功能

- **AI 驱动的提交信息生成**: 使用大语言模型智能分析代码变更并生成专业的提交信息
- **OpenAI 兼容 API 支持**: 支持所有 OpenAI 兼容的 LLM 服务（OpenAI、Azure OpenAI、Ollama、LocalAI 等）
- **约定式提交格式**: 自动生成符合 Conventional Commits 规范的提交信息
- **多语言支持**: 支持中文和英文提交信息生成

#### 配置管理 (需求 1)

- ✅ **API 配置界面**: 提供完整的配置界面用于设置 API 端点、密钥和模型名称 (需求 1.1, 1.2, 1.3)
- ✅ **安全存储**: API 密钥安全存储在 VSCode SecretStorage 中 (需求 1.4)
- ✅ **配置验证**: 自动验证配置的有效性和完整性 (需求 1.5)
- ✅ **配置向导**: 首次使用时自动引导用户完成配置
- ✅ **配置迁移**: 自动将旧版本的明文 API 密钥迁移到安全存储

#### Git 集成 (需求 2)

- ✅ **Git 仓库检测**: 自动检测当前工作区是否为 Git 仓库 (需求 2.1)
- ✅ **暂存变更获取**: 获取暂存区的文件变更列表和详细差异 (需求 2.2, 2.3)
- ✅ **智能过滤**: 自动过滤二进制文件和大文件的差异内容 (需求 2.4)
- ✅ **变更验证**: 在无暂存变更时提示用户先暂存变更 (需求 2.5)
- ✅ **Diff 优化**: 智能截断和格式化 diff 内容，避免超出 LLM 上下文限制

#### LLM 服务调用 (需求 3)

- ✅ **提示词构建**: 将 Git 差异内容格式化为 LLM 可理解的提示词 (需求 3.1)
- ✅ **API 调用**: 使用配置的 API 信息调用 OpenAI 兼容的 LLM 服务 (需求 3.2)
- ✅ **加载状态**: 在调用 LLM 时显示进度指示器 (需求 3.3)
- ✅ **响应解析**: 解析并提取 LLM 生成的提交信息 (需求 3.4)
- ✅ **错误处理**: 完善的 API 错误处理和重试机制 (需求 3.5)
- ✅ **请求超时**: 30 秒超时机制，防止长时间等待
- ✅ **自动重试**: 失败时自动重试最多 3 次，使用指数退避策略
- ✅ **取消支持**: 支持取消正在进行的 API 请求

#### 用户界面 (需求 4)

- ✅ **提交信息预览**: 在输入框中显示生成的提交信息 (需求 4.1)
- ✅ **编辑功能**: 允许用户编辑生成的提交信息 (需求 4.2)
- ✅ **操作按钮**: 提供接受、重新生成和取消按钮 (需求 4.3, 4.4, 4.5)
- ✅ **进度反馈**: 在状态栏和进度条中显示操作进度
- ✅ **友好提示**: 清晰的用户提示和操作引导

#### 命令和快捷方式 (需求 5)

- ✅ **命令面板集成**: 在 VSCode 命令面板中注册命令 (需求 5.1)
- ✅ **SCM 视图集成**: 在源代码管理视图中提供快捷按钮 (需求 5.2)
- ✅ **键盘快捷键**: 支持 `Ctrl+Shift+G C` (Mac: `Cmd+Shift+G C`) 快捷键 (需求 5.3)
- ✅ **完整流程**: 触发命令时执行完整的生成流程 (需求 5.4)
- ✅ **状态栏显示**: 在状态栏显示操作进度 (需求 5.5)

#### 错误处理 (需求 6)

- ✅ **配置错误处理**: 配置缺失时提示用户完成配置 (需求 6.1)
- ✅ **网络错误处理**: 网络连接失败时显示清晰的错误信息 (需求 6.2)
- ✅ **API 错误处理**: API 返回错误时显示具体的错误原因 (需求 6.3)
- ✅ **Git 错误处理**: Git 命令执行失败时显示相关错误信息 (需求 6.4)
- ✅ **详细日志**: 记录详细的错误日志用于调试 (需求 6.5)
- ✅ **错误分类**: 区分不同类型的错误（401, 429, 500 等）
- ✅ **操作建议**: 为每种错误类型提供具体的解决建议
- ✅ **快捷操作**: 提供"打开设置"、"重试"、"查看日志"等快捷按钮

#### 提交信息质量 (需求 7)

- ✅ **简洁标题**: 生成简洁明了的提交标题 (需求 7.1)
- ✅ **详细描述**: 在必要时提供详细的提交描述 (需求 7.2)
- ✅ **约定式格式**: 使用约定式提交格式（Conventional Commits） (需求 7.3)
- ✅ **语言配置**: 支持用户配置的语言（中文/英文） (需求 7.4)
- ✅ **长度限制**: 限制提交标题长度在 50-72 字符范围内 (需求 7.5)
- ✅ **格式验证**: 验证生成的提交信息格式和长度
- ✅ **后处理优化**: 对生成的提交信息进行后处理和优化

### 🔧 Technical Implementation

#### 架构设计

- **模块化架构**: 清晰的模块划分（ConfigurationManager、GitService、LLMService、UIManager、ErrorHandler）
- **TypeScript**: 使用 TypeScript 开发，提供完整的类型安全
- **异步处理**: 所有 IO 操作使用异步处理，不阻塞 VSCode 主线程
- **错误边界**: 完善的错误处理和恢复机制

#### 性能优化

- **Diff 内容限制**: 单个文件 diff 限制 5000 行，总 diff 限制 20000 字符
- **智能过滤**: 过滤不相关的文件（如 package-lock.json）
- **请求优化**: 合理的 max_tokens 限制（500-1000）
- **资源管理**: 内存占用 <50MB，响应时间 <100ms

#### 安全性

- **密钥安全**: API 密钥使用 VSCode SecretStorage 安全存储
- **日志安全**: 不在日志中记录敏感信息
- **输入验证**: 验证所有用户输入，防止注入攻击

### 📚 Documentation

- ✅ **README.md**: 完整的功能介绍、安装指南和使用说明
- ✅ **配置示例**: 提供多种服务的配置示例（OpenAI、Azure OpenAI、Ollama 等）
- ✅ **使用示例**: 提供实际的代码变更和生成的提交信息示例
- ✅ **FAQ**: 常见问题解答
- ✅ **提示词模板**: 自定义提示词和优化技巧
- ✅ **约定式提交指南**: 完整的 Conventional Commits 规范说明

### 🧪 Testing

- ✅ **单元测试**: 为所有核心模块编写单元测试
  - ConfigurationManager 测试
  - GitService 测试
  - LLMService 测试
  - ErrorHandler 测试
- ✅ **集成测试**: 测试完整的提交信息生成流程
- ✅ **错误场景测试**: 测试各种错误场景的处理
- ✅ **测试覆盖率**: 达到 >80% 的代码覆盖率

### 🎯 Supported Services

支持以下 OpenAI 兼容服务：

- **OpenAI**: 官方 OpenAI API
- **Azure OpenAI**: Azure 托管的 OpenAI 服务
- **Ollama**: 本地运行的开源模型
- **LocalAI**: 本地 OpenAI 兼容服务
- **LM Studio**: 桌面 LLM 应用
- **Text Generation WebUI**: Oobabooga 的 WebUI
- **vLLM**: 高性能 LLM 推理引擎
- **其他**: 任何实现 OpenAI API 格式的服务

### 📦 Package Information

- **Extension ID**: `ai-git-commit`
- **Display Name**: AI Git Commit
- **Version**: 0.0.1
- **Publisher**: SleepSheep
- **VSCode Engine**: ^1.85.0
- **Categories**: SCM Providers, Other
- **License**: MIT

### 🔗 Dependencies

- **axios**: ^1.6.2 - HTTP 客户端，用于 API 调用
- **TypeScript**: ^5.3.3 - 开发语言
- **Jest**: ^30.2.0 - 测试框架

---

## 🐛 Known Issues

### 当前已知问题

1. **大型变更集**: 当变更文件过多或 diff 内容过大时，可能会超出 LLM 的上下文限制
   - **临时解决方案**: 分批暂存和提交变更

2. **特殊字符处理**: 某些特殊字符在 diff 中可能导致格式问题
   - **临时解决方案**: 手动编辑生成的提交信息

3. **网络代理**: 在某些网络代理环境下可能需要额外配置
   - **临时解决方案**: 配置 VSCode 的代理设置

4. **模型响应质量**: 不同模型生成的提交信息质量可能有差异
   - **建议**: 使用 GPT-3.5-turbo 或更高版本的模型

### 限制

- 仅支持 Git 版本控制系统
- 需要网络连接（除非使用本地模型）
- 依赖 LLM 服务的可用性和响应速度

---

## 🚀 Future Plans

### 计划中的功能

#### v0.1.0 - 增强功能

- [ ] **自定义提示词模板**: 允许用户完全自定义提示词
- [ ] **提交历史学习**: 分析项目历史提交，学习项目特定的提交风格
- [ ] **批量提交**: 支持为多个变更集生成提交信息
- [ ] **智能拆分**: 自动识别并建议拆分大型变更
- [ ] **提交信息模板**: 提供多种预设的提交信息模板

#### v0.2.0 - 集成增强

- [ ] **Issue 跟踪集成**: 自动关联 Issue 编号（GitHub、GitLab、Jira 等）
- [ ] **团队规范**: 支持团队共享的提交规范配置
- [ ] **代码审查集成**: 在代码审查时生成变更摘要
- [ ] **CI/CD 集成**: 支持在 CI/CD 流程中使用

#### v0.3.0 - 高级功能

- [ ] **多仓库支持**: 同时管理多个 Git 仓库
- [ ] **变更分类**: 自动将变更分类为不同的提交
- [ ] **提交信息评分**: 评估提交信息质量并提供改进建议
- [ ] **统计和分析**: 提供提交信息质量统计和分析

#### v0.4.0 - 性能和体验

- [ ] **流式响应**: 支持 LLM 流式响应，实时显示生成过程
- [ ] **离线模式**: 支持完全离线使用（需要本地模型）
- [ ] **缓存机制**: 缓存最近的生成结果，加快响应速度
- [ ] **增量更新**: 支持增量更新提交信息

#### 长期规划

- [ ] **多语言扩展**: 支持更多语言（日语、韩语、法语等）
- [ ] **插件生态**: 提供 API 供其他插件调用
- [ ] **Web 版本**: 提供 Web 版本的提交信息生成器
- [ ] **移动端支持**: 支持移动端 Git 客户端集成
- [ ] **AI 模型微调**: 提供针对特定项目的模型微调功能

### 改进计划

- **性能优化**: 进一步优化 diff 处理和 API 调用性能
- **错误处理**: 增强错误处理和恢复机制
- **用户体验**: 改进 UI/UX，提供更流畅的交互体验
- **文档完善**: 提供更详细的文档和教程
- **测试覆盖**: 提高测试覆盖率到 >90%

---

## 📝 Notes

### 开发说明

- 本项目遵循 [Conventional Commits](https://www.conventionalcommits.org/) 规范
- 使用 [Semantic Versioning](https://semver.org/) 进行版本管理
- 欢迎提交 Issue 和 Pull Request

### 致谢

感谢所有为本项目做出贡献的开发者和用户！

---

## 🔗 Links

- **GitHub Repository**: [待添加]
- **VSCode Marketplace**: [待发布]
- **Documentation**: [README.md](./README.md)
- **Issue Tracker**: [待添加]
- **Changelog**: [CHANGELOG.md](./CHANGELOG.md)

---

**[0.0.1]**: 2024-11-14
