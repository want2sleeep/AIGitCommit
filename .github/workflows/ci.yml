name: CI

on:
  push:
    branches: [master, develop]
  pull_request:
    branches: [master, develop]

# å–æ¶ˆåŒä¸€åˆ†æ”¯ä¸Šçš„é‡å¤è¿è¡Œ
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥ï¼ˆå¹¶è¡Œæ‰§è¡Œï¼‰
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run linter
        run: pnpm run lint

  format:
    name: Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Check code formatting
        run: pnpm run format:check

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Type Check
        run: pnpm run type-check

  # æµ‹è¯•ä½œä¸šï¼ˆå¹¶è¡Œæ‰§è¡Œå¤šä¸ª Node ç‰ˆæœ¬ï¼‰
  test:
    name: Test (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version: [18.x, 20.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.1
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run tests with coverage
        run: pnpm exec jest --coverage --runInBand
      
      - name: Archive coverage report
        uses: actions/upload-artifact@v4
        if: matrix.node-version == '20.x'
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

  # è¦†ç›–çŽ‡æŠ¥å‘Šï¼ˆä»…åœ¨ Node 20.x æµ‹è¯•å®ŒæˆåŽï¼‰
  coverage-report:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: test
    if: always() && needs.test.result == 'success'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download coverage report
        uses: actions/download-artifact@v4
        with:
          name: coverage-report
          path: coverage/
      
      - name: Display coverage summary
        run: |
          echo "## ðŸ“Š æµ‹è¯•è¦†ç›–çŽ‡æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f coverage/coverage-summary.json ]; then
            # æå–è¦†ç›–çŽ‡æ•°æ®
            LINES=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct')
            STATEMENTS=$(cat coverage/coverage-summary.json | jq -r '.total.statements.pct')
            FUNCTIONS=$(cat coverage/coverage-summary.json | jq -r '.total.functions.pct')
            BRANCHES=$(cat coverage/coverage-summary.json | jq -r '.total.branches.pct')
            
            echo "| æŒ‡æ ‡ | è¦†ç›–çŽ‡ | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
            echo "|------|--------|------|" >> $GITHUB_STEP_SUMMARY
            
            # æ£€æŸ¥æ˜¯å¦è¾¾åˆ° 70% é˜ˆå€¼
            check_threshold() {
              local value=$1
              local name=$2
              if (( $(echo "$value >= 70" | bc -l) )); then
                echo "| $name | ${value}% | âœ… |" >> $GITHUB_STEP_SUMMARY
              else
                echo "| $name | ${value}% | âš ï¸ |" >> $GITHUB_STEP_SUMMARY
              fi
            }
            
            check_threshold "$LINES" "è¡Œè¦†ç›–çŽ‡"
            check_threshold "$STATEMENTS" "è¯­å¥è¦†ç›–çŽ‡"
            check_threshold "$FUNCTIONS" "å‡½æ•°è¦†ç›–çŽ‡"
            check_threshold "$BRANCHES" "åˆ†æ”¯è¦†ç›–çŽ‡"
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ç›®æ ‡è¦†ç›–çŽ‡: 70%" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ è¦†ç›–çŽ‡æŠ¥å‘Šæ–‡ä»¶ä¸å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Check coverage thresholds
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            LINES=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct')
            BRANCHES=$(cat coverage/coverage-summary.json | jq -r '.total.branches.pct')
            FUNCTIONS=$(cat coverage/coverage-summary.json | jq -r '.total.functions.pct')
            STATEMENTS=$(cat coverage/coverage-summary.json | jq -r '.total.statements.pct')
            
            THRESHOLD=70
            FAILED=0
            
            echo "æ£€æŸ¥è¦†ç›–çŽ‡é˜ˆå€¼ (ç›®æ ‡: ${THRESHOLD}%)..."
            echo ""
            
            if (( $(echo "$LINES < $THRESHOLD" | bc -l) )); then
              echo "âŒ è¡Œè¦†ç›–çŽ‡ ${LINES}% ä½ŽäºŽé˜ˆå€¼ ${THRESHOLD}%"
              FAILED=1
            else
              echo "âœ… è¡Œè¦†ç›–çŽ‡ ${LINES}% è¾¾æ ‡"
            fi
            
            if (( $(echo "$BRANCHES < $THRESHOLD" | bc -l) )); then
              echo "âŒ åˆ†æ”¯è¦†ç›–çŽ‡ ${BRANCHES}% ä½ŽäºŽé˜ˆå€¼ ${THRESHOLD}%"
              FAILED=1
            else
              echo "âœ… åˆ†æ”¯è¦†ç›–çŽ‡ ${BRANCHES}% è¾¾æ ‡"
            fi
            
            if (( $(echo "$FUNCTIONS < $THRESHOLD" | bc -l) )); then
              echo "âŒ å‡½æ•°è¦†ç›–çŽ‡ ${FUNCTIONS}% ä½ŽäºŽé˜ˆå€¼ ${THRESHOLD}%"
              FAILED=1
            else
              echo "âœ… å‡½æ•°è¦†ç›–çŽ‡ ${FUNCTIONS}% è¾¾æ ‡"
            fi
            
            if (( $(echo "$STATEMENTS < $THRESHOLD" | bc -l) )); then
              echo "âŒ è¯­å¥è¦†ç›–çŽ‡ ${STATEMENTS}% ä½ŽäºŽé˜ˆå€¼ ${THRESHOLD}%"
              FAILED=1
            else
              echo "âœ… è¯­å¥è¦†ç›–çŽ‡ ${STATEMENTS}% è¾¾æ ‡"
            fi
            
            if [ $FAILED -eq 1 ]; then
              echo ""
              echo "âš ï¸ è¦†ç›–çŽ‡æœªè¾¾æ ‡ï¼Œä½†ä¸é˜»æ­¢æž„å»º"
            fi
          fi

  # æž„å»ºä½œä¸šï¼ˆç­‰å¾…æ‰€æœ‰æ£€æŸ¥å®Œæˆï¼‰
  build:
    name: Build Extension
    runs-on: ubuntu-latest
    needs: [lint, format, type-check, test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build extension
        run: pnpm run vscode:prepublish
      
      - name: Package extension
        run: |
          pnpm install -g @vscode/vsce
          vsce package --no-dependencies
      
      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: vsix-package
          path: '*.vsix'
          retention-days: 30
      
      - name: Build summary
        run: |
          VERSION=$(node -p "require('./package.json').version")
          VSIX_FILE="aigitcommit-${VERSION}.vsix"
          
          echo "## ðŸŽ‰ æž„å»ºæˆåŠŸ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | å€¼ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| ç‰ˆæœ¬ | ${VERSION} |" >> $GITHUB_STEP_SUMMARY
          echo "| VSIX æ–‡ä»¶ | ${VSIX_FILE} |" >> $GITHUB_STEP_SUMMARY
          echo "| Node.js | 20.x |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "VSIX æ–‡ä»¶å·²ä¸Šä¼ ä¸º Actions åˆ¶å“ï¼Œå¯ä»Ž Actions é¡µé¢ä¸‹è½½ã€‚" >> $GITHUB_STEP_SUMMARY
