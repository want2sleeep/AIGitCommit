name: Publish to Marketplace

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'å¹²è¿è¡Œï¼ˆä»…æ‰“åŒ…ï¼Œä¸å‘å¸ƒï¼‰'
        required: false
        type: boolean
        default: false

jobs:
  validate:
    name: Validate Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.extract.outputs.version }}
      is_prerelease: ${{ steps.extract.outputs.is_prerelease }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Extract version from tag
        id: extract
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            TAG="${{ github.event.release.tag_name }}"
            IS_PRERELEASE="${{ github.event.release.prerelease }}"
          else
            TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
            IS_PRERELEASE="false"
          fi
          
          echo "Tag: $TAG"
          
          # Validate tag format
          if ! echo "$TAG" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$'; then
            echo "é”™è¯¯: æ— æ•ˆçš„ç‰ˆæœ¬æ ‡ç­¾æ ¼å¼: $TAG"
            echo "æœŸæœ›æ ¼å¼: vX.Y.Z æˆ– vX.Y.Z-prerelease"
            exit 1
          fi
          
          # Extract version without 'v' prefix
          VERSION=${TAG#v}
          
          # Detect prerelease from tag format (contains hyphen after version)
          if echo "$VERSION" | grep -q '-'; then
            IS_PRERELEASE="true"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          echo "Is prerelease: $IS_PRERELEASE"

      - name: Validate package.json version
        run: |
          VERSION="${{ steps.extract.outputs.version }}"
          PKG_VERSION=$(node -p "require('./package.json').version")
          
          echo "Tag version: $VERSION"
          echo "package.json version: $PKG_VERSION"
          
          if [ "$VERSION" != "$PKG_VERSION" ]; then
            echo "é”™è¯¯: ç‰ˆæœ¬ä¸åŒ¹é…"
            echo "æ ‡ç­¾ç‰ˆæœ¬æ˜¯ v$VERSION ä½† package.json ä¸­æ˜¯ $PKG_VERSION"
            exit 1
          fi
          
          echo "âœ“ ç‰ˆæœ¬éªŒè¯é€šè¿‡"
      
      - name: Validate CHANGELOG.md
        run: |
          VERSION="${{ steps.extract.outputs.version }}"
          
          if ! grep -qE "^## \[?$VERSION\]?" CHANGELOG.md; then
            echo "é”™è¯¯: CHANGELOG.md ä¸åŒ…å«ç‰ˆæœ¬ $VERSION çš„æ¡ç›®"
            echo "è¯·åœ¨ CHANGELOG.md ä¸­æ·»åŠ ç‰ˆæœ¬æ›´æ–°è¯´æ˜"
            exit 1
          fi
          
          echo "âœ“ CHANGELOG éªŒè¯é€šè¿‡"

  quality:
    name: Quality Checks
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Run linter
        run: pnpm run lint
      
      - name: Check code formatting
        run: pnpm run format:check
      
      - name: Type Check
        run: pnpm run type-check
      
      - name: Run tests
        run: pnpm run test

  publish:
    name: Build and Publish
    runs-on: ubuntu-latest
    needs: [validate, quality]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.18.1
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Build extension
        run: pnpm run vscode:prepublish
      
      - name: Install vsce
        run: pnpm install -g @vscode/vsce
      
      - name: Package extension
        run: vsce package --no-dependencies
      
      - name: Check dry run mode
        id: mode_check
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ "${{ github.event.inputs.dry_run }}" = "true" ]; then
            echo "dry_run=true" >> $GITHUB_OUTPUT
            echo "::notice::ğŸ” å¹²è¿è¡Œæ¨¡å¼å·²å¯ç”¨"
            echo "::notice::å°†åˆ›å»º VSIX åŒ…ä½†ä¸ä¼šå‘å¸ƒåˆ°æ’ä»¶å¸‚åœº"
            echo ""
            echo "====================================="
            echo "        å¹²è¿è¡Œæ¨¡å¼ (DRY RUN)"
            echo "====================================="
            echo "âœ“ å°†æ‰§è¡Œæ‰€æœ‰æ„å»ºå’Œæ‰“åŒ…æ­¥éª¤"
            echo "âœ“ å°†ä¸Šä¼  VSIX æ–‡ä»¶ä½œä¸ºåˆ¶å“"
            echo "âœ— ä¸ä¼šå‘å¸ƒåˆ°æ’ä»¶å¸‚åœº"
            echo "âœ— ä¸ä¼šåˆ›å»ºå‘å¸ƒè¯„è®º"
            echo "====================================="
          else
            echo "dry_run=false" >> $GITHUB_OUTPUT
            echo "::notice::ğŸš€ ç”Ÿäº§æ¨¡å¼"
            echo "::notice::å°†æ„å»ºå¹¶å‘å¸ƒåˆ°æ’ä»¶å¸‚åœº"
            echo ""
            echo "====================================="
            echo "         ç”Ÿäº§æ¨¡å¼ (PRODUCTION)"
            echo "====================================="
            echo "âœ“ å°†æ‰§è¡Œæ‰€æœ‰æ„å»ºå’Œæ‰“åŒ…æ­¥éª¤"
            echo "âœ“ å°†ä¸Šä¼  VSIX æ–‡ä»¶ä½œä¸ºåˆ¶å“"
            echo "âœ“ å°†å‘å¸ƒåˆ°æ’ä»¶å¸‚åœº"
            echo "âœ“ å°†åˆ›å»ºå‘å¸ƒè¯„è®ºï¼ˆå¦‚æœæ˜¯ release äº‹ä»¶ï¼‰"
            echo "====================================="
          fi
      
      - name: Upload VSIX artifact
        uses: actions/upload-artifact@v4
        with:
          name: vsix-package
          path: '*.vsix'
          retention-days: 30
      
      - name: Dry run summary
        if: steps.mode_check.outputs.dry_run == 'true'
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          VSIX_FILE="aigitcommit-${VERSION}.vsix"
          
          echo "::notice::âœ… å¹²è¿è¡Œå®Œæˆ"
          echo ""
          echo "====================================="
          echo "       å¹²è¿è¡Œæ¨¡å¼ - å®Œæˆ"
          echo "====================================="
          echo "âœ“ VSIX åŒ…å·²åˆ›å»º: $VSIX_FILE"
          echo "âœ“ åˆ¶å“å·²ä¸Šä¼ åˆ° GitHub Actions"
          echo "âœ“ å¯ä»¥ä» Actions æ ‡ç­¾é¡µä¸‹è½½ VSIX æ–‡ä»¶"
          echo ""
          echo "ä¸‹ä¸€æ­¥ï¼š"
          echo "1. ä» Actions è¿è¡Œé¡µé¢ä¸‹è½½ VSIX åˆ¶å“"
          echo "2. æ‰‹åŠ¨æµ‹è¯• VSIX æ–‡ä»¶"
          echo "3. å¦‚æœæµ‹è¯•é€šè¿‡ï¼Œåˆ›å»ºæ­£å¼ Release è¿›è¡Œå‘å¸ƒ"
          echo "====================================="
      
      - name: Publish to Marketplace
        if: steps.mode_check.outputs.dry_run != 'true'
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}
        run: |
          VERSION="${{ needs.validate.outputs.version }}"
          IS_PRERELEASE="${{ needs.validate.outputs.is_prerelease }}"
          
          # Validate PAT exists
          if [ -z "$VSCE_PAT" ]; then
            echo "::error::VSCE_PAT secret æœªè®¾ç½®æˆ–ä¸ºç©º"
            echo ""
            echo "====================================="
            echo "        PAT é…ç½®é”™è¯¯"
            echo "====================================="
            echo "é”™è¯¯: VSCE_PAT secret æœªè®¾ç½®"
            echo ""
            echo "è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤é…ç½® Personal Access Token:"
            echo "1. è®¿é—® https://marketplace.visualstudio.com/manage"
            echo "2. åˆ›å»ºæ–°çš„ Personal Access Token"
            echo "3. è®¾ç½®æƒé™èŒƒå›´ä¸º 'Marketplace (Manage)'"
            echo "4. å¤åˆ¶ç”Ÿæˆçš„ Token"
            echo "5. åœ¨ GitHub ä»“åº“ä¸­æ·»åŠ  Secret:"
            echo "   - è¿›å…¥ Settings > Secrets and variables > Actions"
            echo "   - ç‚¹å‡» 'New repository secret'"
            echo "   - Name: VSCE_PAT"
            echo "   - Value: [ç²˜è´´æ‚¨çš„ Token]"
            echo "====================================="
            exit 1
          fi
          
          VSIX_FILE="aigitcommit-${VERSION}.vsix"
          
          # Verify VSIX file exists
          if [ ! -f "$VSIX_FILE" ]; then
            echo "::error::VSIX æ–‡ä»¶ä¸å­˜åœ¨: $VSIX_FILE"
            echo "é”™è¯¯: æ‰¾ä¸åˆ°æ‰“åŒ…çš„ VSIX æ–‡ä»¶"
            exit 1
          fi
          
          echo "å‡†å¤‡å‘å¸ƒåˆ°æ’ä»¶å¸‚åœº..."
          echo "ç‰ˆæœ¬: $VERSION"
          echo "æ–‡ä»¶: $VSIX_FILE"
          echo "é¢„å‘å¸ƒ: $IS_PRERELEASE"
          echo ""
          
          # Publish with error handling
          set +e  # Disable exit on error to capture output
          
          if [ "$IS_PRERELEASE" = "true" ]; then
            echo "å‘å¸ƒé¢„å‘å¸ƒç‰ˆæœ¬ $VERSION..."
            OUTPUT=$(vsce publish --packagePath "./$VSIX_FILE" --pre-release 2>&1)
            EXIT_CODE=$?
          else
            echo "å‘å¸ƒç¨³å®šç‰ˆæœ¬ $VERSION..."
            OUTPUT=$(vsce publish --packagePath "./$VSIX_FILE" 2>&1)
            EXIT_CODE=$?
          fi
          
          set -e  # Re-enable exit on error
          
          # Check if publish was successful
          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error::å‘å¸ƒåˆ°æ’ä»¶å¸‚åœºå¤±è´¥"
            echo ""
            echo "====================================="
            echo "        å‘å¸ƒå¤±è´¥"
            echo "====================================="
            echo "ç‰ˆæœ¬: $VERSION"
            echo "é€€å‡ºä»£ç : $EXIT_CODE"
            echo ""
            echo "é”™è¯¯è¯¦æƒ…:"
            echo "$OUTPUT"
            echo ""
            echo "====================================="
            echo ""
            echo "å¸¸è§é—®é¢˜æ’æŸ¥:"
            echo "1. æ£€æŸ¥ VSCE_PAT æ˜¯å¦æœ‰æ•ˆä¸”æœªè¿‡æœŸ"
            echo "2. ç¡®è®¤ Token å…·æœ‰ 'Marketplace (Manage)' æƒé™"
            echo "3. éªŒè¯å‘å¸ƒè€… ID æ˜¯å¦æ­£ç¡®"
            echo "4. æ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦å·²å­˜åœ¨äºæ’ä»¶å¸‚åœº"
            echo "5. æŸ¥çœ‹ä¸Šæ–¹çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯"
            echo "====================================="
            exit 1
          fi
          
          echo ""
          echo "====================================="
          echo "        å‘å¸ƒæˆåŠŸ"
          echo "====================================="
          echo "âœ“ æˆåŠŸå‘å¸ƒåˆ°æ’ä»¶å¸‚åœº"
          echo "ç‰ˆæœ¬: $VERSION"
          echo "ç±»å‹: $([ "$IS_PRERELEASE" = "true" ] && echo "é¢„å‘å¸ƒ" || echo "ç¨³å®šç‰ˆæœ¬")"
          echo ""
          echo "å‘å¸ƒè¾“å‡º:"
          echo "$OUTPUT"
          echo "====================================="
      
      - name: Post success feedback to release
        if: success() && github.event_name == 'release' && steps.mode_check.outputs.dry_run != 'true'
        continue-on-error: true
        uses: actions/github-script@v7
        env:
          VERSION: ${{ needs.validate.outputs.version }}
          IS_PRERELEASE: ${{ needs.validate.outputs.is_prerelease }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // å‡†å¤‡æ•°æ®
            const version = process.env.VERSION;
            const isPrerelease = process.env.IS_PRERELEASE === 'true';
            const marketplaceUrl = 'https://marketplace.visualstudio.com/items?itemName=SleepSheep.aigitcommit';
            const timestamp = new Date().toLocaleString('zh-CN', { 
              timeZone: 'Asia/Shanghai',
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit'
            });
            const versionType = isPrerelease ? 'é¢„å‘å¸ƒç‰ˆæœ¬' : 'ç¨³å®šç‰ˆæœ¬';
            
            // æ„å»ºçŠ¶æ€æ¶ˆæ¯
            const statusMessage = [
              '',
              '---',
              '',
              '## ğŸš€ å‘å¸ƒçŠ¶æ€ï¼šæˆåŠŸ',
              '',
              '**ç‰ˆæœ¬**: `' + version + '`',
              '**ç±»å‹**: ' + versionType,
              '**å‘å¸ƒæ—¶é—´**: ' + timestamp,
              '**æ’ä»¶å¸‚åœº**: ' + marketplaceUrl,
              '',
              'âœ… æ’ä»¶å·²æˆåŠŸå‘å¸ƒåˆ° VS Code æ’ä»¶å¸‚åœº',
              '',
              '**å®‰è£…æ–¹å¼**:',
              '- åœ¨ VS Code ä¸­æœç´¢ "AI Git Commit"',
              '- è®¿é—®æ’ä»¶å¸‚åœºé¡µé¢ç›´æ¥å®‰è£…',
              '- ä½¿ç”¨å‘½ä»¤: `code --install-extension SleepSheep.aigitcommit`',
              ''
            ].join('\n');
            
            try {
              // 1. æ›´æ–° Release æ­£æ–‡
              const release = await github.rest.repos.getRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: context.payload.release.id
              });
              
              const updatedBody = release.data.body + statusMessage;
              
              await github.rest.repos.updateRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: context.payload.release.id,
                body: updatedBody
              });
              
              console.log('âœ“ Release æ­£æ–‡å·²æ›´æ–°');
              
              // 2. å†™å…¥å·¥ä½œæµæ‘˜è¦
              fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, statusMessage);
              console.log('âœ“ å·¥ä½œæµæ‘˜è¦å·²å†™å…¥');
              
            } catch (error) {
              console.error('å‘å¸ƒåé¦ˆå¤±è´¥ï¼ˆä¸å½±å“å‘å¸ƒç»“æœï¼‰:', error.message);
            }
      
      - name: Post failure feedback to release
        if: failure() && github.event_name == 'release'
        continue-on-error: true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // å‡†å¤‡æ•°æ®
            const version = '${{ needs.validate.outputs.version }}' || 'æœªçŸ¥';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const timestamp = new Date().toLocaleString('zh-CN', { 
              timeZone: 'Asia/Shanghai',
              year: 'numeric',
              month: '2-digit',
              day: '2-digit',
              hour: '2-digit',
              minute: '2-digit',
              second: '2-digit'
            });
            
            // æ„å»ºçŠ¶æ€æ¶ˆæ¯
            const statusMessage = [
              '',
              '---',
              '',
              '## âŒ å‘å¸ƒçŠ¶æ€ï¼šå¤±è´¥',
              '',
              '**ç‰ˆæœ¬**: `' + version + '`',
              '**å¤±è´¥æ—¶é—´**: ' + timestamp,
              '**å·¥ä½œæµè¿è¡Œ**: [æŸ¥çœ‹è¯¦ç»†æ—¥å¿—](' + runUrl + ')',
              '',
              'âš ï¸ æ’ä»¶å‘å¸ƒåˆ° VS Code æ’ä»¶å¸‚åœºå¤±è´¥',
              '',
              '**ä¸‹ä¸€æ­¥æ“ä½œ**:',
              '1. ç‚¹å‡»ä¸Šæ–¹é“¾æ¥æŸ¥çœ‹è¯¦ç»†çš„å·¥ä½œæµæ—¥å¿—',
              '2. æ£€æŸ¥å¤±è´¥æ­¥éª¤çš„é”™è¯¯æ¶ˆæ¯',
              '3. æ ¹æ®é”™è¯¯ä¿¡æ¯ä¿®å¤é—®é¢˜',
              '4. ä¿®å¤åå¯ä»¥é‡æ–°è§¦å‘å·¥ä½œæµ',
              '',
              '**å¸¸è§é—®é¢˜**:',
              '- **ç‰ˆæœ¬éªŒè¯å¤±è´¥**: ç¡®ä¿ package.json ç‰ˆæœ¬ä¸ Release æ ‡ç­¾åŒ¹é…',
              '- **è´¨é‡æ£€æŸ¥å¤±è´¥**: è¿è¡Œ `pnpm run lint` å’Œ `pnpm run test` ä¿®å¤é—®é¢˜',
              '- **PAT è®¤è¯å¤±è´¥**: æ£€æŸ¥ VSCE_PAT secret æ˜¯å¦æ­£ç¡®é…ç½®',
              '- **å‘å¸ƒå¤±è´¥**: éªŒè¯ç‰ˆæœ¬å·æ˜¯å¦å·²å­˜åœ¨äºæ’ä»¶å¸‚åœº',
              ''
            ].join('\n');
            
            try {
              // 1. æ›´æ–° Release æ­£æ–‡
              const release = await github.rest.repos.getRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: context.payload.release.id
              });
              
              const updatedBody = release.data.body + statusMessage;
              
              await github.rest.repos.updateRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: context.payload.release.id,
                body: updatedBody
              });
              
              console.log('âœ“ Release æ­£æ–‡å·²æ›´æ–°');
              
              // 2. å†™å…¥å·¥ä½œæµæ‘˜è¦
              fs.appendFileSync(process.env.GITHUB_STEP_SUMMARY, statusMessage);
              console.log('âœ“ å·¥ä½œæµæ‘˜è¦å·²å†™å…¥');
              
            } catch (error) {
              console.error('å‘å¸ƒåé¦ˆå¤±è´¥:', error.message);
            }
